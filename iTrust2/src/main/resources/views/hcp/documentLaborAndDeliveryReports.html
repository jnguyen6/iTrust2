<html xmlns:th="http://www.thymeleaf.org">

<head th:include="layout :: head(title=~{::title},links=~{::script})">
<title>View Patient Obstetrics Records</title>
<script th:src="@{/resources/js/dateTimeService.js}"
	src="../resources/js/dateTimeService.js"></script>
</head>

<body th:include="layout :: body" th:with="content=~{::content}">
	<div th:fragment="content">

		<script th:inline="javascript">
                /* Otherwise Thymeleaf tries to parse Javascript as XML and breaks itself sometimes.  Sigh */
                /*<![CDATA[*/
                var app = angular.module('myApp', ['dateTimeServices']);
                app.controller('documentLaborAndDeliveryReports', function ($scope, $http, dateTimeService) {
                    $scope.Object = Object; // Allows for use of Object.keys()
                    $scope.obstetricsRecords = {};
                    $scope.currentRecord = false;
                    const now = new Date();
    				$scope.input= {};
                    $scope.entry = {
        					lmp: dateTimeService.toDateString(now),
        					conception: '',
        					currentRecord: true
        			};
                    $scope.current = {};
                    $scope.adding = {
                    		lmp: dateTimeService.toDateString(now),
                    		type: '',
                    		twins: '',
                    		currentRecord: false
                    }
                    $scope.birthTypes = ['Vaginal', 'Cesarean', 'Miscarriage'];
                    $scope.yesOrNo = ['true', 'false'];
                    $scope.newOne = false;
                    $scope.newOneEmpty = false;
                    $scope.showTable = false;
                    $scope.addNew = function (){
                    	$scope.newOne = true;
                    }
                    $scope.addEmpty = function() {
                    	$scope.newOneEmpty = true;
                    }
                    $scope.resetNewOneEmpty = function() {
                    	$scope.newOne = false;
                    	$scope.newOneEmpty = false;
                    	$scope.errorMsg = "";
                    	$scope.errorMsg1 = "";
                    	$scope.input.date = "";
                    	$scope.showTable = false;
                    	$scope.adding.conception = null;
						$scope.adding.weeksPreg = null;
						$scope.adding.hoursInLabor = null;
						$scope.adding.twins = '';
						$scope.adding.type = '';
                    }
                    

                    $scope.displayName = function (p) {
                        return p.firstName + " " + p.lastName + " (" + p.self.username + ")";
                    }

                    // documentation on Angular filters: https://docs.angularjs.org/api/ng/filter/filter
                    $scope.searchFilter = "";
                    $scope.filterPatients = function (patient) {
                        return ($scope.displayName(patient)).toLowerCase().match($scope.searchFilter.toLowerCase());
                    }
                    
                    $scope.makeDueDate = function(){
                    	var estimateDate = "" + $scope.current.dueDate;
                    	var year = estimateDate.substring(0, 4);
                    	var month = estimateDate.substring(5, 7);
                    	var day = estimateDate.substring(8);
                    	var estimate = new Date(year, month - 1, day);
                    	estimate.setTime( estimate.getTime() + 280 * 86400000 + Math.abs( estimate.getTimezoneOffset()*60000 ) );
                    	var newString = dateTimeService.toDateString(estimate);
                    	$scope.current.dueDate = newString;
                    }
                    
                    $scope.getWeeks = function () {
                    	var today = new Date();
                    	var estimateDate = "" + $scope.current.lmp;
                    	var year = estimateDate.substring(0, 4);
                    	var month = estimateDate.substring(5, 7);
                    	var day = estimateDate.substring(8);
                    	var estimate = new Date(year, month - 1, day);
                    	var difference = today.getTime() - estimate.getTime();
                    	var daysSince = Math.floor( difference / 86400000 );
                    	var weeksSince = Math.floor( daysSince / 7 );
                    	$scope.current.weeksPreg = weeksSince;
                    }

                    $http.get("/iTrust2/api/v1/patients").then(
                        function (response) {
                            $scope.patients = response.data;
                            $scope.hold = [];
                            var counter = 0;
                            for( i = 0; i < $scope.patients.length; i++){
                            	if($scope.patients[i].gender == "Female"){
                            		$scope.hold[counter] = $scope.patients[i];
                            		counter = counter + 1;
                            	}
                            }
                            $scope.patients = $scope.hold;
                            $scope.selectPatient = function (patient) {
                                $scope.selectedDate = null; // Reset selected date

                                $scope.loadEntries = function () {
                                    // Get diary entries for selected patient
                                    $http.get("/iTrust2/api/v1/obstetricsRecord/" + $scope.selectedPatient).then(
                                        function (response) {
                                            $scope.obstetricsRecords = response.data || {};
                                            $scope.obstetricsRecords = $scope.groupDates($scope.obstetricsRecords, 'conception');
                                            var hold = [];
                                            var count = 0;
                                            for(j = Object.keys($scope.obstetricsRecords).length - 1; j >= 0; j--){
                                            	for(k = 0; k < Object.values($scope.obstetricsRecords)[j].length; k++){
                                            		hold[count] = Object.values($scope.obstetricsRecords)[j][k];
                                            		count++;
                                            	}
                                            }
                                            $scope.obstetricsRecords = $scope.groupDates(hold, 'date');
                                            $scope.currentRecord = false;
                                            if(Object.keys($scope.obstetricsRecords).length > 0) {
	                                            for(i = 0; i < Object.values($scope.obstetricsRecords)[0].length; i++){
	                                            	if( Object.values($scope.obstetricsRecords)[0][i].currentRecord ){
	                                            		$scope.currentRecord = true;
	                                            		$scope.current.lmp = Object.values($scope.obstetricsRecords)[0][i].lmp;
	                                            		$scope.current.dueDate = Object.values($scope.obstetricsRecords)[0][i].lmp;
	                                            		$scope.makeDueDate();
	                                            		$scope.getWeeks();
	                                            	} else {
	                                            		$scope.showTable = true;
	                                            	}
	                                            }
                                            }
                                            $scope.message = "";
                                        },
                                        function (rejection) {
                                            $scope.obstetricsRecords = [];
                                            $scope.message = "Could not display records.";
                                        });
                                };

                                $scope.loadEntries();
                            };
                        },
                        function (rejection) {
                            $scope.patient = null;
                        });

                    // Split entries into groups by date
                    $scope.groupDates = function (arr, key) {
                        var groups = {};

                        for (var i = 0; l = arr.length, i < l; i++) {
                            groups[arr[i][key]] = groups[arr[i][key]] || [];
                            groups[arr[i][key]].push(arr[i]);
                        }

                        // Sort the groups by date in reverse chronological order
                        const orderedGroups = {};
                        Object.keys(groups).sort( function( a, b ) { return a.localeCompare(b) } ).forEach(function(key) {
                            orderedGroups[key] = groups[key];
                        });

                        return orderedGroups;
                    };                
                $scope.failAddLMP = function () {
					$scope.errorMsg += "Could not add Obstetrics Record."
					$scope.message = "";
				}
                
                $scope.failAddLMP1 = function () {
					$scope.errorMsg1 += "Could not add Obstetrics Record."
					$scope.message1 = "";
				}
                
                $scope.submit = function () {
					$scope.errorMsg1 = "";
					// Validate entry date
					var date = new Date($scope.input.date);
					var now = new Date();
					if (!dateTimeService.isValidDate(date) || now - date < 0) {
						$scope.errorMsg1 += "Please input a valid date.\n";
					} else {
						$scope.entry.lmp = dateTimeService.toDateString(date);
						$scope.entry.conception = date.getYear() + 1900;
						$scope.entry.currentRecord = true;
						//$scope.entry.type = "Vaginal";
					}
					
					// Check to ensure a patient is authenticated and the form is correct.
					if ($scope.errorMsg1.length >= 1 ) {
						$scope.failAddLMP1();
						return;
					}
					
					// Prepare entry for submission
					//var submitEntry = angular.copy($scope.entry);
					//submitEntry.lmp = dateTimeService.toDateString(date);

					// POST the entry to the REST API endpoint, and handle
					// success/error
					$http.post("/iTrust2/api/v1/obstetricsRecord/" + $scope.selectedPatient, $scope.entry).then(
						function success(response) {
							if (response.data.patient) {
								$scope.message = "";
								$scope.message1 = "Your obstetrics record has been added successfully."
								$scope.entry = {};
								$scope.errorMsg1 = "";
								$http.get("/iTrust2/api/v1/obstetricsRecord/" + $scope.selectedPatient).then(
                                        function (response2) {
                                            $scope.obstetricsRecords = response2.data || {};
                                            console.log($scope.obstetricsRecords);
                                            $scope.obstetricsRecords = $scope.groupDates($scope.obstetricsRecords, 'conception');
                                            console.log($scope.obstetricsRecords);
                                            var hold = [];
                                            var count = 0;
                                            for(j = Object.keys($scope.obstetricsRecords).length - 1; j >= 0; j--){
                                            	for(k = 0; k < Object.values($scope.obstetricsRecords)[j].length; k++){
                                            		hold[count] = Object.values($scope.obstetricsRecords)[j][k];
                                            		count++;
                                            	}
                                            }
                                            $scope.obstetricsRecords = $scope.groupDates(hold, 'date');
                                 });
								$scope.currentRecord = true;
                        		$scope.current.lmp = response.data.lmp;
                        		$scope.current.dueDate = response.data.lmp;
                        		$scope.makeDueDate();
                        		$scope.getWeeks();
								//document.location.href = '/iTrust2/hcp/documentObstetricsRecords';
							} else {
								// Redirected to login page,
								// not actually successful
								$scope.failAddLMP1();
							}
						}, function failure(rejection) {
							$scope.failAddLMP1();
						}
					);
				}
                
                $scope.add = function () {
                	$scope.errorMsg = "";
					
					if (!$scope.adding.type) {
						$scope.errorMsg += "A delivery type must be selected\n";
					}
					
					if (!$scope.adding.twins) {
						$scope.errorMsg += "Select if the delivery was twins\n";
					} else {
						if($scope.adding.twins == "true"){
							$scope.adding.twins = true;
						} else {
							$scope.adding.twins = false;
						}
					}
					
					// Validate nutrition values - they are all validated the
					// same way, so we use a for loop to check and propagate all
					// errors.
					var theValues = {
						"conception": $scope.adding.conception,
						"weeksPreg": $scope.adding.weeksPreg,
						"hoursInLabor": $scope.adding.hoursInLabor
					};
					
					for ( type in theValues ) {
						if ( theValues[type] == null || theValues[type] < 0 ) {
							$scope.errorMsg += `Field ${type} must be a positive whole number.\n`;
						}
					}
					
					// Check to ensure a patient is authenticated and the form is correct.
					if ($scope.errorMsg.length >= 1 ) {
						$scope.failAddLMP();
						return;
					}

					// POST the entry to the REST API endpoint, and handle
					// success/error
					$http.post("/iTrust2/api/v1/obstetricsRecord/" + $scope.selectedPatient, $scope.adding).then(
							function success(response) {
								if (response.data.patient) {
									$scope.message1 = "";
									$scope.message = "Your obstetrics record has been added successfully."
									$scope.entry = {};
									$scope.errorMsg = "";
									$scope.newOne = false;
									$scope.newOneEmpty = false;
									$scope.showTable = true;
									console.log("-----------------");
									console.log($scope.obstetricsRecords);
									$http.get("/iTrust2/api/v1/obstetricsRecord/" + $scope.selectedPatient).then(
	                                        function (response2) {
	                                            $scope.obstetricsRecords = response2.data || {};
	                                            console.log($scope.obstetricsRecords);
	                                            $scope.obstetricsRecords = $scope.groupDates($scope.obstetricsRecords, 'conception');
	                                            console.log($scope.obstetricsRecords);
	                                            var hold = [];
	                                            var count = 0;
	                                            for(j = Object.keys($scope.obstetricsRecords).length - 1; j >= 0; j--){
	                                            	for(k = 0; k < Object.values($scope.obstetricsRecords)[j].length; k++){
	                                            		hold[count] = Object.values($scope.obstetricsRecords)[j][k];
	                                            		count++;
	                                            	}
	                                            }
	                                            $scope.obstetricsRecords = $scope.groupDates(hold, 'date');
	                                 });
									$scope.adding.conception = null;
									$scope.adding.weeksPreg = null;
									$scope.adding.hoursInLabor = null;
									$scope.adding.twins = '';
									$scope.adding.type = '';
									//document.location.href = '/iTrust2/hcp/documentObstetricsRecords';
								} else {
									// Redirected to login page,
									// not actually successful
									$scope.failAddLMP();
								}
							}, function failure(rejection) {
								$scope.failAddLMP();
							}
						);
                }
                
                });

                /*app.filter('sumByColumn', function () {
                    return function (collection, column, serving) {
                        var total = 0;

                        collection.forEach(function (item) {
                            total += parseInt(item[serving]) * parseInt(item[column]);
                        });

                        return total;
                    };
                })
                /*]]>*/
            </script>

		<div ng-app="myApp" ng-controller="documentLaborAndDeliveryReports" class="row">
			<div class="col-md-3">
				<h2>Patients:</h2>
				<!-- info on filtering taken from here: https://www.w3schools.com/angular/angular_filters.asp
                    and https://docs.angularjs.org/api/ng/filter/filter -->
				<h4>
					Search: <input type="text" name="search" ng-model="searchFilter" />
				</h4>
				<!-- Info on scrolling taken from here: https://www.w3schools.com/cssref/pr_pos_overflow.asp -->
				<!-- and here: https://stackoverflow.com/questions/9560330/how-to-hide-a-vertical-scroll-bar-when-not-needed -->
				<div>
					<div class="radio"
						ng-repeat="patient in patients | filter:filterPatients">
						<label> <input type="radio" id="{{patient.self.username}}"
							ng-model="$parent.selectedPatient" name="patient"
							value="{{patient.self.username}}"
							ng-click='$parent.selectPatient(patient)' />
							&nbsp;{{$parent.displayName(patient)}}
						</label>
					</div>
				</div>
			</div>

			<div class="col-md-2">
				<div class="panel panel-primary">
					<div class="panel-heading">
						<h3>Reports:</h3>
					</div>
					<div class="panel-body">
						<div style="margin-left: 10px;">
							<div ng-if="Object.keys(diaryReports).length > 0"></div>

							<div class="radio" ng-repeat="(date, entry) in diaryReports">
								<label> <input type="radio"
									ng-model="$parent.selectedDate" name="date" value="{{date}}"
									required="true" /> {{date | date : 'MM/dd/yyyy'}}
								</label>
							</div>

							<div ng-if="!selectedPatient">Please select a patient to view their labor and delivery Reports.</div>
							<div
								ng-if="selectedPatient && (!diaryReports || Object.keys(diaryReports).length == 0)">
								There are no labor and delivery reports for this patient.</div>
						</div>
					</div>
				</div>
			</div>
			<div class="col-md-7">
				<div class="panel panel-primary">
					<div class="panel-heading">
						<h3>
							<b>View Labor and Delivery Reports</b>
						</h3>
					</div>
					<div class="panel-body">
						<div ng-hide="selectedDate">Please select a delivery report</div>
						<div class="panel panel-primary" ng-show="selectedDate"
							ng-repeat="(date, Reports) in diaryReports"
							ng-if="date == selectedDate">
							<div class="panel-heading">
								<h3>
									<b>Labor:</b>
								</h3>
								<div class="panel panel-default">
									<div class="panel-body">


										<div class="form-group row">
											<div class="col-xs-6">
												<label>Date:</label>
											</div>
											<div name='date' class="form-group col-md-2">
												{{Reports.date | date : 'MM/dd/yyyy'}}</div>
										</div>
										<div class="form-group row">
											<div class="col-xs-6">
												<label>Time:</label>
											</div>
											<div name='time' class="form-group col-md-2">
												{{selectedReport.date | date : 'shortTime'}}</div>
										</div>


									</div>


									<!-- Delivery Panel -->
									<div class="col-md-8">
										<div class="panel panel-info">
											<div class="panel-heading">
												<h4>Delivery:</h4>
											</div>
											<div class="panel-body">
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Date:</label>
													</div>
													<div class="col-xs-6">
														<input type="date" class="form-control" name="dateDelivery"
															ng-model="dateDelivery" required />
													</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Time:</label>
													</div>
													<div name='deliveryTime' class="form-group col-md-2">
														{{selectedReport.deliveryTime | date : 'shortTime'}}</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Type:</label>
													</div>
													<div class="col-xs-6 ">
														<div name='deliveryType' class="form-check">
															{{selectedReport.deliveryType}}</div>
													</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Weight:</label>
													</div>
													<div name='weightOne' class="col-xs-6">
														{{selectedReport.weightOne}}</div>
													<div name='weightTwo' class="col-xs-6">
														{{selectedReport.weightTwo}}</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Length:</label>
													</div>
													<div name='length' class="col-xs-6">
														{{selectedReport.length}}</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Heart Rate:</label>
													</div>
													<div name='heartRate' class="col-xs-6">
														{{selectedReport.heartRate}}</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Blood Pressure:</label>
													</div>
													<div name='bloodPressure' class="col-xs-6">
														{{selectedReport.bloodPressure}}</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>First Name:</label>
													</div>
													<div name='firstName' class="col-xs-6">
														{{selectedReport.firstName}}</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Last Name:</label>
													</div>
													<div name='lastName' class="col-xs-6">
														{{selectedReport.lastName}}</div>
												</div>


											</div>
										</div>
									</div>

									<!-- Twin Delivery Panel -->
									<div class="col-md-8" ng-show="isTwins">
										<div class="panel panel-info">
											<div class="panel-heading">
												<h4>Delivery:</h4>
											</div>
											<div class="panel-body">
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Date:</label>
													</div>
													<div name='date' class="col-xs-6">
														{{selectedReport.date}}</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Time:</label>
													</div>
													<div name='time' class="col-xs-6">
														{{selectedReport.date | date : 'shortTime'}}</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Type:</label>
													</div>
													<div class="col-xs-6 ">
														<div name='deliveryTypeTwin' class="form-check">
															{{selectedReport.deliveryTypeTwin}}</div>
													</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Weight:</label>
													</div>
													<div name='weightOneTwin' class="col-xs-6">
														{{selectedReport.weightOneTwin}}</div>
													<div name='weightTwoTwin' class="col-xs-6">
														{{selectedReport.weightTwoTwin}}</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Length:</label>
													</div>
													<div name='lengthTwin' class="col-xs-6">
														{{selectedReport.lengthTwin}}</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Heart Rate:</label>
													</div>
													<div name='heartRateTwin' class="col-xs-6">
														{{selectedReport.heartRateTwin}}</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Blood Pressure:</label>
													</div>
													<div name='bloodPressureTwin' class="col-xs-6">
														{{selectedReport.bloodPressureTwin}}</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>First Name:</label>
													</div>
													<div name='firstNameTwin' class="col-xs-6">
														{{selectedReport.firstNameTwin}}</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Last Name:</label>
													</div>
													<div name='lastNameTwin' class="col-xs-6">
														{{selectedReport.lastNameTwin}}</div>
												</div>


											</div>
										</div>
									</div>

								</div>
							</div>
					</div>
				</div>
			</div>
		</div>
		</div>
</body>

</html>
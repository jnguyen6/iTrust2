<html xmlns:th="http://www.thymeleaf.org">
<head th:include="layout :: head(title=~{::title},links=~{::script})">
<title>View Labor and Delivery Reports</title>
<script th:src="@{/resources/js/dateTimeService.js}"
  src="../resources/js/dateTimeService.js"></script>
</head>

<body th:include="layout :: body" th:with="content=~{::content}">
  <div th:fragment="content">
    <div class="container">

      <script th:inline="javascript">
      /* Otherwise Thymeleaf tries to parse Javascript as XML and breaks itself sometimes.  Sigh */
      /*<![CDATA[*/
      var app = angular.module('viewLaborAndDeliveryReportsApp', []);
      /**
        * A filter to humanize the text to be more user friendly.
        */
      app.filter('humanize', function () {
        return function (input) {
          return !input ? input : input.toLowerCase().split('_')
            .map((word) => word.charAt(0).toUpperCase() + word.substring(1))
            .join(' ');
        }
      });
      app.controller(
        'viewLaborAndDeliveryReportsCtrl',
        function ($scope, $http) {
          $http.get("/iTrust2/api/v1/officevisits/myofficevisits").then(
            function (response) {
              $scope.noVisitSelected = true;
              $scope.loadingVisits = false;
              $scope.visits = response.data;
              var visitsLength = $scope.visits.length;
              //The problem is that the visit does not contain an actual reference to the patient as a patient, only as a user
              //to get around this, we will use the patients api which can get us this mapping, and we will have angular help
              for (var i = 0; i < visitsLength; i++) {
                  
                  //passing to inner loop taken from https://stackoverflow.com/questions/17244614/passing-variable-to-promise-in-a-loop
                  (function (i) {
                      $http.get("/iTrust2/api/v1/patients/" + $scope.visits[i].patient.username).then(
                          function (response) {
                              $scope.visits[i].actualPatient = response.data;
                          });
                  })(i);
              }
            });
          $scope.selectedVisitID = null;
          $scope.selectedVisit = {};
          
         
          $scope.populateVisit = function () {
            $scope.showBHM = true;
            for (var i = 0; i < $scope.visits.length; i++) {
              //gets general info and basic health metrics
              if ($scope.visits[i].id == $scope.selectedVisitID) {
                $scope.selectedVisit.patient = $scope.visits[i].patient.username;
                $scope.selectedVisit.hcp = $scope.visits[i].hcp.username;
                $scope.selectedVisit.notes = $scope.visits[i].notes;
                $scope.selectedVisit.type = $scope.visits[i].type;
                $scope.selectedVisit.hospital = $scope.visits[i].hospital.name;
                $scope.selectedVisit.date = $scope.visits[i].date;
                $scope.selectedVisit.id = $scope.visits[i].id;
                $scope.selectedVisit.height = $scope.visits[i].basicHealthMetrics.height;
               
                $scope.selectedVisit.headCircumference = $scope.visits[i].basicHealthMetrics.headCircumference;
                $scope.selectedVisit.systolic = $scope.visits[i].basicHealthMetrics.systolic;
                $scope.selectedVisit.diastolic = $scope.visits[i].basicHealthMetrics.diastolic;
                $scope.selectedVisit.hdl = $scope.visits[i].basicHealthMetrics.hdl;
                $scope.selectedVisit.ldl = $scope.visits[i].basicHealthMetrics.ldl;
                $scope.selectedVisit.tri = $scope.visits[i].basicHealthMetrics.tri;
                $scope.selectedVisit.houseSmokingStatus = $scope.visits[i].basicHealthMetrics.houseSmokingStatus;
                $scope.selectedVisit.patientSmokingStatus = $scope.visits[i].basicHealthMetrics.patientSmokingStatus;
                //view Labor and Delivery Reports
                $scope.selectedVisit.dateLabor = $scope.selectedVisit.date;
                $scope.selectedVisit.timeLabor = $scope.selectedVisit.time;
                $scope.selectedVisit.timeLaborTwin = $scope.selectedVisit.date;
                $scope.selectedVisit.deliveryTime = "6:00PM";
                $scope.selectedVisit.deliveryTimeTwin = "7:00PM";
                $scope.selectedVisit.dateDelivery = "4/16/2019";
                $scope.selectedVisit.dateDeliveryTwin = $scope.selectedVisit.date;
                $scope.selectedVisit.deliveryType = "Vaginal Delivery";
                $scope.selectedVisit.deliveryTypeTwin = "Vaginal Delivery";
                $scope.selectedVisit.weightOne = "5";
                $scope.selectedVisit.weightTwo = "8";
                $scope.selectedVisit.weightOneTwin = "5";
                $scope.selectedVisit.weightTwoTwin = "8";
                $scope.selectedVisit.length = "18";
                $scope.selectedVisit.lengthTwin = "18"
                $scope.selectedVisit.heartRate = "90";
                $scope.selectedVisit.heartRateTwin = "92";
                $scope.selectedVisit.bloodPressure = "64/41";
                $scope.selectedVisit.bloodPressureTwin = "64/41";
                $scope.selectedVisit.firstName = "jake";
                $scope.selectedVisit.firstNameTwin = "clay";
                $scope.selectedVisit.lastName = "obby";
                $scope.selectedVisit.lastNameTwin = "obby";
                //$scope.isTwins = true;
                
                validateBasicHealthMetrics();
                // Eye health metrics
                $scope.selectedVisit.visualAcuityOS = $scope.visits[i].visualAcuityOS;
                $scope.selectedVisit.visualAcuityOD = $scope.visits[i].visualAcuityOD;
                $scope.selectedVisit.sphereOS = $scope.visits[i].sphereOS;
                $scope.selectedVisit.sphereOD = $scope.visits[i].sphereOD;
                $scope.selectedVisit.cylinderOS = $scope.visits[i].cylinderOS;
                $scope.selectedVisit.cylinderOD = $scope.visits[i].cylinderOD;
                $scope.selectedVisit.axisOS = $scope.visits[i].axisOS;
                $scope.selectedVisit.axisOD = $scope.visits[i].axisOD;
                $scope.selectedVisit.eyeDiagnoses = undefined;
                if($scope.visits[i].diagnosis !== undefined && $scope.visits[i].diagnosis !== "")
                	$scope.selectedVisit.eyeDiagnoses = $scope.visits[i].diagnosis.split(",");
                $scope.selectedVisit.surgeryType = $scope.visits[i].surgeryType;
                // Diagnoses
                if ($scope.selectedVisit.type == 'GENERAL_CHECKUP') {
                  $http.get("/iTrust2/api/v1/diagnosesforvisit/" + $scope.selectedVisitID).then(
                    function (response) {
                      $scope.diagnosesResponse = response.data;
                      for (var i = 0; i < $scope.diagnosesResponse.length; i++) {
                        $scope.diagnoses.push({
                          note: $scope.diagnosesResponse[i].note,
                          code: $scope.diagnosesResponse[i].code
                        });
                      }
                    });
                  // Prescriptions
                  let prescriptions = $scope.visits[i].prescriptions;
                  for (var j = 0; j < prescriptions.length; j++) {
                    var prescription = prescriptions[j];
                    $scope.prescriptions.push({
                      drug: prescription.drug.code,
                      dosage: prescription.dosage,
                      startDate: prescription.startDate,
                      endDate: prescription.endDate,
                      renewals: prescription.renewals
                    });
                  }
                  // Lab procedures
                  $http.get("/iTrust2/api/v1//labprocedures/byVisit/" + $scope.selectedVisitID).then(
                    function (response) {
                      $scope.proceduresResponse = response.data;
                      for (var i = 0; i < $scope.proceduresResponse.length; i++) {
                        var procedure = $scope.proceduresResponse[i];
                        $scope.procedures.push({
                          code: procedure.loinc.code,
                          commonName: procedure.loinc.commonName,
                          priority: procedure.priority,
                          comments: procedure.comments,
                          status: procedure.status
                        });
                      }
                    });
                }
              }
            }
          }
        });
			/*]]>*/
            </script>

			<div ng-app="viewLaborAndDeliveryReportsApp" ng-controller="viewLaborAndDeliveryReportsCtrl">
				<div class="container">
					<div class="row" style="margin-top: 1em">

						<div class="col-md-4">
							<div class="panel panel-default">
								<div class="panel-heading">
									<h4>Reports:</h4>
								</div>
								<div class="panel-body">
									<div class="row">
										<div class="col-md-4">
											<ul style="list-style: none;">
												<li ng-repeat="visit in visits">
													<h4>
														<label> <input type="radio"
															ng-model="$parent.selectedVisitID"
															ng-click="populateVisit()" name="{{visit.id}}"
															id="selectVisit" value="{{visit.id}}" required="true" />
															{{visit.date | date : 'MM/dd/yyyy'}} at {{visit.date |
															date : 'shortTime'}}
														</label>
													</h4>
												</li>
											</ul>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="col-md-8" ng-show="selectedVisit.id">
							<div class="row">
								<!-- <div class="col-md-12"> -->
									<div class="panel panel-primary">
										<div class="panel-heading">
											<h3>View Labor and Delivery Report:</h3>
										</div>
										<div class="panel-body">
											<div class="row">
												<div class="form-group col-md-6">
													<label>Labor:</label>

													<div class="panel panel-default">
														<div class="panel-body">
															
															
															<div class="form-group row">
																<div class="col-xs-6">
																	<label>Date:</label>
																</div>
																<div name='date' class="form-group col-md-2">
																	{{selectedVisit.date | date : 'MM/dd/yyyy'}}</div>
															</div>
															<div class="form-group row">
																<div class="col-xs-6">
																	<label>Time:</label>
																</div>
																<div name='time' class="form-group col-md-2">
																	{{selectedVisit.date | date : 'shortTime'}}</div>
															</div>
															
																																						
														</div>
												

											
												<!-- Delivery Panel -->
												<div class="col-md-8">
													<div class="panel panel-info">
														<div class="panel-heading">
															<h4>Delivery:</h4>
														</div>
														<div class="panel-body">
<!-- 															<div class="form-group row"> -->
<!-- 																<div class="col-xs-6"> -->
<!-- 																	<label>Date:</label> -->
<!-- 																</div> -->
<!-- 																<div name='date' class="col-xs-6"> -->
<!-- 																	{{selectedVisit.date}}</div> -->
<!-- 															</div> -->
<!-- 															<div class="form-group row"> -->
<!-- 																<div class="col-xs-6"> -->
<!-- 																	<label>Time:</label> -->
<!-- 																</div> -->
<!-- 																<div name='time' class="col-xs-6"> -->
<!-- 																	{{selectedVisit.date | date : 'shortTime'}}</div> -->
<!-- 															</div> -->
                                                            <div class="form-group row">
																<div class="col-xs-6">
																	<label>Date:</label>
																</div>
																<div name='dateDelivery' class="form-group col-md-2">
																	{{selectedVisit.dateDelivery | date : 'MM/dd/yyyy'}}</div>
															</div>
															<div class="form-group row">
																<div class="col-xs-6">
																	<label>Time:</label>
																</div>
																<div name='deliveryTime' class="form-group col-md-2">
																	{{selectedVisit.deliveryTime | date : 'shortTime'}}</div>
															</div>
															<div class="form-group row">
																<div class="col-xs-6">
																	<label>Type:</label>
																</div>
																<div class="col-xs-6 ">
																	<div name='deliveryType' class="form-check">
																		{{selectedVisit.deliveryType}}</div>
																</div>
															</div>
															<div class="form-group row">
																<div class="col-xs-6">
																	<label>Weight:</label>
																</div>
																<div name='weightOne' class="col-xs-6">
																	{{selectedVisit.weightOne}}</div>
																<div name='weightTwo' class="col-xs-6">
																	{{selectedVisit.weightTwo}}</div>
															</div>
															<div class="form-group row">
																<div class="col-xs-6">
																	<label>Length:</label>
																</div>
																<div name='length' class="col-xs-6">
																	{{selectedVisit.length}}</div>
															</div>
															<div class="form-group row">
																<div class="col-xs-6">
																	<label>Heart Rate:</label>
																</div>
																<div name='heartRate' class="col-xs-6">
																	{{selectedVisit.heartRate}}</div>
															</div>
															<div class="form-group row">
																<div class="col-xs-6">
																	<label>Blood Pressure:</label>
																</div>
																<div name='bloodPressure' class="col-xs-6">
																	{{selectedVisit.bloodPressure}}</div>
															</div>
															<div class="form-group row">
																<div class="col-xs-6">
																	<label>First Name:</label>
																</div>
																<div name='firstName' class="col-xs-6">
																	{{selectedVisit.firstName}}</div>
															</div>
															<div class="form-group row">
																<div class="col-xs-6">
																	<label>Last Name:</label>
																</div>
																<div name='lastName' class="col-xs-6">
																	{{selectedVisit.lastName}}</div>
															</div>
															
															
														</div>
													</div>
												</div>
												
												<!-- Twin Delivery Panel -->
												<div class="col-md-8" ng-show="isTwins">
													<div class="panel panel-info">
														<div class="panel-heading">
															<h4>Delivery:</h4>
														</div>
														<div class="panel-body">
															<div class="form-group row">
																<div class="col-xs-6">
																	<label>Date:</label>
																</div>
																<div name='date' class="col-xs-6">
																	{{selectedVisit.date}}</div>
															</div>
															<div class="form-group row">
																<div class="col-xs-6">
																	<label>Time:</label>
																</div>
																<div name='time' class="col-xs-6">
																	{{selectedVisit.date | date : 'shortTime'}}</div>
															</div>
															<div class="form-group row">
																<div class="col-xs-6">
																	<label>Type:</label>
																</div>
																<div class="col-xs-6 ">
																	<div name='deliveryTypeTwin' class="form-check">
																		{{selectedVisit.deliveryTypeTwin}}</div>
																</div>
															</div>
															<div class="form-group row">
																<div class="col-xs-6">
																	<label>Weight:</label>
																</div>
																<div name='weightOneTwin' class="col-xs-6">
																	{{selectedVisit.weightOneTwin}}</div>
																<div name='weightTwoTwin' class="col-xs-6">
																	{{selectedVisit.weightTwoTwin}}</div>
															</div>
															<div class="form-group row">
																<div class="col-xs-6">
																	<label>Length:</label>
																</div>
																<div name='lengthTwin' class="col-xs-6">
																	{{selectedVisit.lengthTwin}}</div>
															</div>
															<div class="form-group row">
																<div class="col-xs-6">
																	<label>Heart Rate:</label>
																</div>
																<div name='heartRateTwin' class="col-xs-6">
																	{{selectedVisit.heartRateTwin}}</div>
															</div>
															<div class="form-group row">
																<div class="col-xs-6">
																	<label>Blood Pressure:</label>
																</div>
																<div name='bloodPressureTwin' class="col-xs-6">
																	{{selectedVisit.bloodPressureTwin}}</div>
															</div>
															<div class="form-group row">
																<div class="col-xs-6">
																	<label>First Name:</label>
																</div>
																<div name='firstNameTwin' class="col-xs-6">
																	{{selectedVisit.firstNameTwin}}</div>
															</div>
															<div class="form-group row">
																<div class="col-xs-6">
																	<label>Last Name:</label>
																</div>
																<div name='lastNameTwin' class="col-xs-6">
																	{{selectedVisit.lastNameTwin}}</div>
															</div>
															
															
														</div>
													</div>
												</div>
												
											</div>

											
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	</div>

</body>

</html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:include="layout :: head(title=~{::title},links=~{::script})">
<title>View Labor and Delivery Reports</title>
<script th:src="@{/resources/js/dateTimeService.js}"
  src="../resources/js/dateTimeService.js"></script>
</head>

<body th:include="layout :: body" th:with="content=~{::content}">
  <div th:fragment="content">
    <div class="container">

      <script th:inline="javascript">
            /* Otherwise Thymeleaf tries to parse Javascript as XML and breaks itself sometimes.  Sigh */
            /*<![CDATA[*/
            var app = angular.module("viewRecordsApp", ['dateTimeServices']);
            app.controller('viewRecordsCtrl', function ($scope, $http, dateTimeService) {
                $scope.Object = Object; // Allows for use of Object.keys()
                $scope.laborDeliveryReports  = {};
                $scope.hasLaborDeliveryReports = false;
                $scope.showTable = false;
                const now = new Date();
                $scope.current = {};
                
                //Navigate to documentLaborAndDeliveryReports page
                $scope.add = function() {
                	location.href = href = '/iTrust2/patient/foodDiary/addFoodDiaryEntry';
                };
                
                $scope.loadRecords = function () {
                    // Get Labor and Delivery Reports
                    $http.get('/iTrust2/api/v1/laborAndDeliveryReports/').then(function (response) {
                        $scope.diaryEntries = response.data || {};
                        $scope.diaryEntries = $scope.groupDates($scope.diaryEntries, 'date');
                       
                        $scope.laborDeliveryReports = $scope.groupDates($scope.diaryEntries, 'date');
                        
                        //check if patient has labor and delivery reports
                        
                       	if ( Object.values($scope.laborDeliveryReports).length > 0 ){
                       		hasLaborDeliveryReports = true;
                       	}

                        
                        $scope.message = "";
                    },
                    function (rejection) {
                        $scope.message = "Could not display labor and delivery reports.";
                    });
                };
             
  
                // Split entries into groups by date
                $scope.groupDates = function (arr, key) {
                    var groups = {};

                    for (var i = 0; l = arr.length, i < l; i++) {
                        groups[arr[i][key]] = groups[arr[i][key]] || [];
                        groups[arr[i][key]].push(arr[i]);
                    }

                    // Sort the groups by date in reverse chronological order
                    const orderedGroups = {};
                    Object.keys(groups).sort( function( a, b ) { return b.localeCompare(a) } ).forEach(function(key) {
                        orderedGroups[key] = groups[key];
                    });

                    return orderedGroups;
                };
                
                $scope.loadRecords();
                
            });

            /*]]>*/
            </script>

		<div ng-app="viewRecordsApp" ng-controller="viewRecordsCtrl">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<div class="panel panel-primary">
							<div class="panel-heading">
								<h3>View Labor and Delivery Reports</h3>
							</div>
						</div>
					</div>
					<div class="panel-body">
							<div style="margin-left:10px;">
								<div> <!-- ng-if="Objects.keys(laborDeliverReports).length >0"> --> 
								Please select a date</div>
								
							<div class="radio" ng-repeat="(date, entry) in Labor and Delivery Reports">
								<label><input type="radio"
										ng-model="$parent.selectedDate" name="date" value"{{date]]"
										required="true" /> {{date | date : 'MM/dd/yyyy' }}
								</label>
							
							</div>
							
							<div
									ng-if="!laborDeliveryReports || Object.keys(laborDeliveryReports).length == 0 ">
									There are no Labor and Delivery Reports
									</div>
									
									<p
									
										ng-show="selectedDate && laborDeliveryReports && Object.keys(laborDeliveryReports).length > 0">
										<b>Labor and Delivery Reports for {{selectedDate | date : 'MM/dd/yyyy'}}</b>
										
									</p>
									
									<table class="table table-bordered">
									<thead>
											<tr>
													<th>Date</th>
													<th>Time</th>
													<th>Type</th>
													<th>Weight</th>
													<th>Length</th>
													<th>Heart Rate</th>
													<th>Blood Pressure</th>
													<th>First Name</th>
													<th>Last Name</th>
											</tr>
								    </thead>
								    <tbody>
								    		<tr ng-repeat="d in entries track by $index">
								    				<td id="date-{{$index}}">{{d.date}}</td>
								    				<td id="time-{{$index}}">{{d.time}}</td>
								    				<td id="type-{{$index}}">{{d.type}}</td>
								    				<td id="weight-{{$index}}">{{d.weight}}</td>
								    				<td id="length-{{$index}}">{{d.length}}</td>
								    				<td id="heartRate-{{$index}}">{{d.heartRate}}</td>
								    				<td id="bloodPressure-{{$index}}">{{d.bloodPressure}}</td>
								    				<td id="firstName-{{$index}}">{{d.firstName}}</td>
								    				<td id="lastName-{{$index}}">{{d.lastName}}</td>
								    		</tr>
								    		
								    			
								    		</tbody>
								    
								    </table>
								    
								    <div class="form-group text-right">
										<button type="button" ng-click="add()" class="btn btn-primary">Add
											New Reports</button>
									</div>
									
						</div>

			<div class="col-md-2">
				<div class="panel panel-primary">
					<div class="panel-heading">
						<h3>Reports:</h3>
					</div>
					<div class="panel-body">
						<div style="margin-left: 10px;">
							<div ng-if="Object.keys(diaryEntries).length > 0"></div>

							<div class="radio" ng-repeat="(date, entry) in diaryEntries">
								<label> <input type="radio"
									ng-model="$parent.selectedDate" name="date" value="{{date}}"
									required="true" /> {{date | date : 'MM/dd/yyyy'}}
								</label>
							</div>

							<div ng-if="!selectedPatient">Please select a patient to view their labor and delivery Reports.</div>
							<div
								ng-if="selectedPatient && (!diaryEntries || Object.keys(diaryEntries).length == 0)">
								There are no labor and delivery reports for this patient.</div>
						</div>
					</div>
				</div>
			</div>
			
</body>

</html>